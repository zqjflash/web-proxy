### 移动端调试之https代理

> 随着各大热门网站全面切换https，那么支持https代理调试已变得非常重要。

#### 首先：我们需要先了解https整个的通信流程；

##### 1. 握手方案：我们以DH握手流程举例，访问百度https站点做分析，查看握手协议和密钥协商

![img](/img/https-connect.png)

我们可以看出握手协议（TLS1.2）和密钥协商方式（ECDHE_RSA with P-256和AES_128_GCM）

##### 2. 从底层分析DH握手完整流程：

 * 客户端明文发送加密套件和一个随机数
 * 服务端返回一个证书（含公钥）和一个随机数
 * 服务端同时返回DH参数和数字签名（用私钥）
 * 客户端发送DH参数
 * 客户端和服务端分别用各自的DH参数+对方发送的DH参数算出第三个随机数，并且用第三个随机数算出密钥

![img](/img/https-dh.png)


##### 3. 证书校验机制

 * CA认证流程图：

![img](/img/https-certification.png)


 * 客户端（浏览器）本身内置根证书，用根证书公钥解密从服务器返回的CA证书。如果解不开或解开异常都认为不受信任，解开后有异常情况比较多（如证书被吊销、证书过期等），证书过期提示：

![img](/img/https-ca1.png)

注：不同浏览器根证书验证目标服务器的CA证书机制有些差异，并不是每次请求都去CA权威机构请求认证
附：CA下发证书是分层的证书链，从根证书一层一层直到网站证书，要验证某一层证书是否确实由上级CA发放的需要验证附带在该证书上的由上级CA通过签名函数及私钥生成的数字签名


带着思考我们首先想到前端代理利器——fiddler，看看它是如何实现https代理过程

#### 其次：fiddler截获客户端浏览器发送给服务器的https请求，此时还未建立握手，接下来具体流程

* 第一步：fiddler向服务器发送请求进行握手，获取到服务器的CA证书，用根证书公钥进行解密，验证服务器数据签名，获取到服务器CA证书公钥；

* 第二步：fiddler伪造自己的CA证书，冒充服务器证书传递给客户端浏览器，客户端浏览器做跟fiddler一样的事；

* 第三步：客户端浏览器生成https通信用的对称密钥，用fiddler伪造的证书公钥加密后传递给服务器，被fiddler截获；

* 第四步：fiddler将截获的密文用自己伪造证书的私钥解开，获得https通信用的对称密钥；

* 第五步：fiddler将对称密钥用服务器证书公钥加密传递给服务器，服务器用私钥解开后建立信任，握手完成，用对称密钥加密消息，开始通信；

* 第六步：fiddler接收到服务器发送的密文，用对称密钥解开，获得服务器发送的明文，再次加密，发送给客户端浏览器。

* 第七步：客户端向服务器发送消息，用对称密钥加密，被fiddler截获后，解密获得明文。

整个过程fiddler一直拥有通信用的对称密钥，所以整个https通信过程中信息对其透明。


![img](/img/crawler.png)

































